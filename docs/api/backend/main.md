# API: `backend/main.py`

このファイルは、FastAPIアプリケーションのメインエントリーポイントであり、すべてのHTTP APIエンドポイントを定義します。

**注意:** このドキュメントはAPIの概要を説明するものです。各エンドポイントのリクエスト/レスポンスの具体的なスキーマ、パラメータ、必須項目などの詳細については、アプリケーション実行中に **`http://localhost:8000/docs`** で閲覧できる、自動生成されたSwagger UIを常に参照してください。

---

## エンドポイントの機能別グループ

### 1. 認証 (Authentication)

- **`POST /token`**
  - **目的**: ユーザーのメールアドレスとパスワードを受け取り、認証が成功した場合にJWT（JSON Web Token）アクセスアクセストークンを発行します。
  - **詳細**: このエンドポイントは、標準的なOAuth2のパスワードフローを実装しています。返されたトークンは、以降の認証が必要なリクエストの `Authorization: Bearer <token>` ヘッダーに含める必要があります。

### 2. ユーザー管理 (User Management)

- **`POST /users/`**
  - **目的**: 新しいユーザーアカウントを作成します。
  - **詳細**: メールアドレスとパスワードを受け取り、データベースに新しいユーザーを登録します。メールアドレスが既に存在する場合はエラーとなります。

### 3. データセット管理 (Dataset Management)

データセットは、ユーザーがドキュメントをグループ化するためのコンテナです。

- **`GET /users/me/datasets/`**
  - **目的**: 認証済みユーザーがアクセス可能なすべてのデータセット（自身がオーナーのパーソナルデータセットと、全ユーザー共有のデータセット）の一覧を取得します。

- **`POST /users/me/datasets/`**
  - **目的**: 新しいパーソナルデータセットを作成します。

- **`DELETE /users/me/datasets/{dataset_id}`**
  - **目的**: 指定されたIDのパーソナルデータセットを削除します。

### 4. ドキュメント管理 (Document Management)

各データセット内の個別のドキュメント（ファイル）を管理します。

- **`GET /users/me/datasets/{dataset_id}/documents/`**
  - **目的**: 指定されたデータセットに含まれる、アップロード済みドキュメントのリストを取得します。

- **`POST /users/me/datasets/{dataset_id}/documents/upload/`**
  - **目的**: 単一のファイルを指定されたデータセットにアップロードし、取り込み処理（Ingestion）を開始します。
  - **詳細**: このエンドポイントは `core.ingestion_service` を呼び出し、ファイルのチャンキングとベクトル化を非同期的に行います。

- **`POST /users/me/datasets/{dataset_id}/documents/upload_batch/`**
  - **目的**: 複数のファイルを一度にアップロードします。

- **`DELETE /users/me/datasets/{dataset_id}/documents/{document_id}`**
  - **目的**: 指定されたドキュメントをデータセットから削除します。（注意: ベクトルDBからの削除処理も必要です）

### 5. チャットとRAG (Chat & RAG)

- **`GET /chat/strategies/`**
  - **目的**: `config/strategies.yaml` で定義されている、利用可能なすべてのRAG戦略のリストを返します。

- **`POST /chat/query/`**
  - **目的**: RAGパイプラインのメインエンドポイント。ユーザーの質問、使用する戦略、対象データセットを受け取り、LLMによる回答を生成します。
  - **詳細**: このエンドポイントは `core.rag_chain_service` を呼び出し、RAGの全プロセスをオーケストレーションします。認証が必須です。
