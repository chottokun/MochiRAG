# MochiRAG システムアーキテクチャ

## 1. 概要

MochiRAGは、マルチテナント対応のRetrieval-Augmented Generation (RAG) アプリケーションです。ユーザーはドキュメントをアップロードし、その内容に基づいてAIと対話することができます。このドキュメントは、MochiRAGの技術的なアーキテクチャ、主要なコンポーネント、処理フロー、および開発の指針について解説し、今後の開発者がスムーズにプロジェクトに参加できるようにすることを目的としています。

## 2. プロジェクトアーキテクチャ

### 2.1. コンポーネント図

MochiRAGは、明確に分離された複数のコンポーネントで構成されています。

```
+----------------+      +------------------+      +----------------+
|   Frontend     |      |     Backend      |      | External       |
|  (Streamlit)   |      |     (FastAPI)    |      | Services       |
+----------------+      +------------------+      +----------------+
       |                      |                      |
       |---(HTTP API)-------->|                      |
       |                      |---(SQL)------------->|  User DB
       |                      |                      |  (SQLite)
       |                      |                      |
       |                      |---(Core Logic)------>|  Core Services
       |                      |                      |  (RAG, LLM, etc.)
       |                      |                      |
       |                      |<--(LLM API)----------|  Ollama
       |                      |                      |
       |                      |<--(Vector DB)--------|  ChromaDB
       |                      |                      |
+----------------+      +------------------+      +----------------+
```

-   **Frontend (Streamlit):** ユーザーインターフェースを提供します。ユーザー認証、ファイルアップロード、チャット画面などを担当し、すべての操作はBackendのAPIを介して行われます。
-   **Backend (FastAPI):** アプリケーションの頭脳となるAPIサーバーです。APIエンドポイントの提供、ユーザー認証、データベースとの連携、そしてCoreコンポーネントの呼び出しを担当します。
-   **Core Services:** RAGの主要なビジネスロジックをカプセル化したPythonモジュール群です。LLM、ベクトルストア、エンベディングモデルなどを管理し、具体的なRAG処理を実行します。
-   **External Services:**
    -   **User DB (SQLite):** ユーザー情報、データセット、ドキュメントのメタデータなどを格納するリレーショナルデータベースです。
    -   **Ollama:** 大規模言語モデル（LLM）を提供する外部サービスです。
    -   **ChromaDB:** ドキュメントのベクトルデータを格納・検索するベクトルデータベースです。

### 2.2. ディレクトリ構造

プロジェクトは、役割ごとに明確にディレクトリが分離されています。

-   `frontend/`: Streamlitで構築されたUI関連のコード。
-   `backend/`: FastAPIで構築されたAPIサーバー関連のコード。データベースモデル（`models.py`）、CRUD操作（`crud.py`）、APIエンドポイント（`main.py`）などが含まれます。
-   `core/`: アプリケーションの中核となるRAGロジック。特定のWebフレームワークに依存しない再利用可能なコンポーネントで構成されます。
-   `config/`: `strategies.yaml`など、アプリケーションの動作を制御するための設定ファイル。
-   `docs/`: プロジェクトのドキュメント。
-   `tests/`: `pytest`を使用したテストコード。

## 3. 主要ライブラリと選定理由

| ライブラリ   | 役割                   | 選定理由                                                                                                                              |
| ------------ | ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------- |
| **FastAPI**  | バックエンドフレームワーク | **パフォーマンスと開発効率の両立。** 非同期処理による高いパフォーマンス、Pydanticとの連携による強力な型チェックと自動APIドキュメント生成機能が、堅牢で開発しやすいAPIサーバーの構築に適しています。 |
| **Streamlit** | フロントエンドフレームワーク | **迅速なプロトタイピング。** PythonのみでインタラクティブなUIを迅速に構築できるため、データ中心のアプリケーションやデモ開発に最適です。複雑なJavaScriptの知識が不要な点も大きな利点です。 |
| **LangChain** | RAGコアフレームワーク    | **RAG開発の標準化とモジュール性。** プロンプト、LLM、リトリーバーといったRAGの構成要素を抽象化し、再利用可能なコンポーネントとして組み合わせることを容易にします。業界標準であり、多くのインテグレーションを提供しています。 |
| **ChromaDB** | ベクトルデータベース     | **手軽さと拡張性。** オープンソースで人気が高く、ローカルでのファイルベース運用から、独立したサーバー運用までスケール可能です。手軽に開始できる点がプロトタイピングに適しています。 |
| **Pydantic** | データバリデーション     | **型安全性と明確なデータ構造。** Pythonの型ヒントに基づき、厳密なデータバリデーションと設定管理を実現します。FastAPIにネイティブで統合されており、コードの信頼性を向上させます。 |
| **Poetry**   | 依存関係管理           | **再現性の高い環境構築。** `poetry.lock`ファイルにより、開発者全員が全く同じバージョンのライブラリを利用することを保証します。仮想環境の管理も統合されており、プロジェクトの依存関係をクリーンに保ちます。 |
| **SQLAlchemy** | ORM (Object-Relational Mapper) | **データベース操作の抽象化。** Pythonのオブジェクトとしてデータベースのテーブルを操作できるようにし、SQLを直接記述する手間を省きます。データベースの種類に依存しないコードを記述できる利点もあります。 |


## 4. 主要な処理フロー

### 4.1. RAGチャットクエリフロー

ユーザーがフロントエンドで質問を送信してから、回答が返るまでのステップバイステップのフローです。

1.  **[Frontend]** ユーザーがチャット入力ボックスに質問を入力し、送信ボタンをクリックします。
2.  **[Frontend]** `frontend/ui_chat.py`がイベントを検知し、`frontend/api_client.py`の関数を呼び出して、質問、選択されたデータセットID、RAG戦略などをBackend APIに送信します。
3.  **[Backend]** `backend/main.py`の`/chat/query/`エンドポイントがリクエストを受け取ります。この際、トークンからユーザーを認証します。
4.  **[Backend]** エンドポイントは`core/rag_chain_service.py`の`rag_chain_service.get_rag_response`関数を呼び出します。
5.  **[Core]** `RAGChainService`内で以下の処理が実行されます。
    a.  `retriever_manager`を呼び出し、指定された戦略とデータセットに対応するリトリーバーを取得します。リトリーバーは内部で`vector_store_manager`を介してChromaDBにアクセスします。
    b.  LangChain Expression Language (LCEL) を用いてRAGチェーンを構築します。
    c.  チェーンが実行され、まずリトリーバーがユーザーの質問に基づいてChromaDBから関連ドキュメントを検索・取得します。
    d.  取得したドキュメントと元の質問がプロンプトテンプレートに挿入されます。
    e.  `llm_manager`を介してOllamaからLLMが取得され、プロンプトが送信されます。
    f.  LLMが生成した回答と、ソースとして使用されたドキュメントが返されます。
6.  **[Backend]** `RAGChainService`から返された結果を、APIレスポンスとしてJSON形式でFrontendに返却します。
7.  **[Frontend]** `api_client`がレスポンスを受け取り、`ui_chat.py`がチャット画面にAIの回答とソースドキュメントを表示します。

## 5. テスト戦略

### 5.1. ツール
-   **`pytest`**: テストフレームワークとして採用されています。強力なフィクスチャ機能やアサーション機能を提供します。

### 5.2. 方針
-   **BackendとCoreの重視**: テストは主に、ビジネスロジックが含まれる`backend/`と`core/`のモジュールに焦点を当てています。
-   **自己完結性**: テストは外部サービス（Ollama, ChromaDBサーバーなど）への依存を排除し、CI/CD環境など、どこでも実行できるように設計されています。
    -   **データベース**: `backend/`のテストでは、本番のSQLiteファイルではなく、インメモリのSQLiteデータベースを使用します。これにより、テストごとクリーンな状態で高速に実行できます。
    -   **外部API**: `httpx`の`TestClient`や`unittest.mock`を利用して、外部APIへのリクエストはモック（偽の応答を返すオブジェクト）に置き換えられます。
-   **カバレッジ**: 今後の課題として、テストカバレッジを計測し、重要なロジックがテストでカバーされていることを保証していくことが望まれます。

### 5.3. 実行方法
プロジェクトのルートディレクトリで以下のコマンドを実行することで、すべてのテストが実行されます。
```bash
pytest
```
