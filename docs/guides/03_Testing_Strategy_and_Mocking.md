# テスト戦略とモック活用ガイド

## 1. テストの基本方針

MochiRAGでは、`pytest` をテストフレームワークとして採用しています。テストの主な目的は、各コンポーネントが単体で正しく動作することを保証する**ユニットテスト**を充実させることです。

特に、`core`ロジック層のテストでは、LLMやベクトルデータベースなどの外部サービスへの依存を完全に排除し、ロジックの正当性のみを検証することに重点を置きます。これにより、高速で安定したテストスイートを維持します。

## 2. 開発サイクルの高速化: LangSmithの活用

LLMアプリケーション、特にRAGパイプラインは内部動作が複雑で、問題発生時の原因特定が困難な場合があります。この課題に対処するため、本プロジェクトでは **[LangSmith](https://smith.langchain.com/)** の積極的な活用を推奨します。

- **目的:**
  - **デバッグと可視化:** すべてのLLMコール、チェーンの実行、リトリーバーの動作を詳細にトレースし、予期せぬ挙動の原因を迅速に特定します。
  - **評価と回帰テスト:** プロンプトの変更やリトリーバー戦略の修正が、システムのパフォーマンスにどのような影響を与えたかを定量的に評価します。手動またはAI支援による評価データセットを作成し、継続的な品質監視を実現します。
  - **A/Bテスト:** 複数のプロンプトやモデル、戦略を並行してテストし、最適な組み合わせをデータに基づいて判断します。

- **導入方法:**
  - 開発者はLangSmithにサインアップし、APIキーを取得します。
  - 必要な環境変数を設定することで、LangChainの実行が自動的にLangSmithにトレースされるようになります。（詳細は[開発者セットアップガイド](./04_Developer_Setup_Guide.md)を参照）

## 3. モッキング戦略

本プロジェクトのテスト容易性は、**Managerパターン**と**モック（Mock）**の活用によって実現されています。

### 3.1. Managerパターンによる依存関係の分離

`LLMManager`, `VectorStoreManager`, `RetrieverManager` などのManagerクラスは、外部ライブラリやサービスへのアクセスを一手に引き受ける窓口です。テスト対象のモジュールは、これらのManagerを介してのみ外部と対話します。

この設計により、テスト時にはManagerの挙動を偽のオブジェクト（モック）に置き換えるだけで、外部依存を簡単に切り離すことができます。

### 3.2. `pytest`フィクスチャによるManagerのモッキング

テスト全体で繰り返し利用するモックは、`pytest`の**フィクスチャ**として定義するのが効果的です。`conftest.py` や各テストファイル内で、`monkeypatch` を利用してグローバルなManagerインスタンスをモックに差し替えます。

### 3.3. `@patch`デコレータによる外部ライブラリのモッキング

`LangChain`などの外部ライブラリのクラスやメソッドを直接モックしたい場合は、`unittest.mock.patch`デコレータを使用します。

例えば、`LLMManager`がOpenAIのクライアントを正しく初期化するかをテストする場合、`@patch("core.llm_manager.ChatOpenAI")` のようにして、実際にAPIコールが発生しないように `ChatOpenAI` クラスそのものをモックします。このアプローチは、AzureやGeminiなど他のプロバイダーのテストでも同様に適用されます。

## 4. 既知の問題と今後のリファクタリング方針

### 4.1. スキップされているテスト

現在、`tests/core/test_retriever_manager.py` 内の一部のテストが、`@pytest.mark.skip`で無効化されています。これらのテストは、今後のタスクとして安定してパスできるように修正することが望まれます。

### 4.2. 今後のリファクタリング方針

- **方針1: 依存性注入 (Dependency Injection) の全面的な導入**
  - **課題:** グローバルなManagerインスタンスへの依存は、テストコードを複雑にします。
  - **解決策:** クラスのコンストラクタや関数の引数を通じて依存オブジェクトを渡す形式にコードを修正し、`monkeypatch`への依存を減らします。

- **方針2: `VectorStoreManager`の責務の拡大とカプセル化**
  - **課題:** Strategyクラスが具体的なベクトルストアライブラリに依存しています。
  - **解決策:** `VectorStoreManager`にリトリーバー取得ロジックをカプセル化し、Strategyクラスをインフラストラクチャ層から切り離します。

- **方針3: LLMに依存する高度なロジックのテスト**
  - **課題:** `SelfQueryRetriever`のように、LLMが動的に処理内容を決定するコンポーネントは、ユニットテストが困難です。
  - **解決策:** `FakeListLLM`の活用、スナップショットテスト、そしてLangSmithを用いたE2E評価を組み合わせ、信頼性を確保します。