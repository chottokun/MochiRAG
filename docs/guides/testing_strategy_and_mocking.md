# テスト戦略とモック活用ガイド

## 1. テストの基本方針

MochiRAGでは、テストフレームワークとして `pytest` を採用しています。テストの主な目的は、各コンポーネントが単体で正しく動作することを保証する**ユニットテスト**を充実させることです。

特に `core` ロジック層のテストでは、LLMやベクトルデータベースといった外部サービスへの依存を `mock` を用いて完全に排除し、ロジックの正当性のみを検証することに重点を置きます。これにより、CI環境でも高速かつ安定して動作するテストスイートを維持します。

## 2. 開発とデバッグの効率化: LangSmithの活用

RAGパイプラインは内部動作が複雑で、問題発生時の原因特定が困難な場合があります。この課題に対処するため、本プロジェクトでは **[LangSmith](https://smith.langchain.com/)** の積極的な活用を推奨します。

- **目的:**
  - **デバッグと可視化:** すべてのLLMコール、チェーンの実行、リトリーバーの動作を詳細にトレースし、予期せぬ挙動の原因を迅速に特定します。
  - **評価と回帰テスト:** プロンプトの変更やリトリーバー戦略の修正が、システムのパフォーマンスにどのような影響を与えたかを定量的に評価します。
  - **A/Bテスト:** 複数のプロンプトやモデル、戦略を並行してテストし、最適な組み合わせをデータに基づいて判断します。

- **導入方法:**
  - 開発者はLangSmithにサインアップし、APIキーを取得します。
  - 必要な環境変数を設定することで、LangChainの実行が自動的にLangSmithにトレースされるようになります。詳細は[開発者セットアップガイド](./developer_setup_guide.md)を参照してください。

## 3. モッキング戦略

本プロジェクトのテスト容易性は、**Managerパターン**と**モック（Mock）**の活用によって実現されています。

### 3.1. Managerパターンによる依存関係の分離

`LLMManager`, `VectorStoreManager`, `RetrieverManager` などのManagerクラスは、外部ライブラリやサービスへのアクセスを一手に引き受ける窓口（Facade）です。テスト対象のモジュールは、これらのManagerを介してのみ外部と対話します。

この設計により、テスト時にはManagerの挙動を偽のオブジェクト（モック）に置き換えるだけで、外部依存を容易に切り離すことができます。

### 3.2. モックの実装方法

- **`pytest`フィクスチャによるManagerのモッキング**: テスト全体で繰り返し利用するモックは、`pytest`の**フィクスチャ**として定義するのが効果的です。`conftest.py` や各テストファイル内で、`monkeypatch` を利用してグローバルなManagerインスタンスをモックに差し替えます。
- **`@patch`デコレータによる外部ライブラリのモッキング**: `LangChain`などの外部ライブラリのクラスやメソッドを直接モックしたい場合は、`unittest.mock.patch`デコレータを使用します。例えば、`LLMManager`がOpenAIのクライアントを正しく初期化するかをテストする場合、`@patch("core.llm_manager.ChatOpenAI")` のようにして、実際にAPIコールが発生しないように `ChatOpenAI` クラスそのものをモックします。

## 4. 今後のリファクタリング方針

コードの保守性とテスト容易性をさらに向上させるため、以下の方針でのリファクタリングが推奨されます。

- **方針1: 依存性注入 (Dependency Injection) の導入**
  - **課題:** グローバルなManagerインスタンス（シングルトン）への依存は、テストコードを複雑にし、見通しを悪くする要因となります。
  - **解決策:** クラスのコンストラクタや関数の引数を通じて、依存オブジェクトを外部から渡す形式（DI）にコードを修正します。これにより `monkeypatch` への依存が減り、コンポーネントの独立性が高まります。

- **方針2: `VectorStoreManager`の責務の拡大とカプセル化**
  - **課題:** `BasicRetrieverStrategy`などの一部の戦略クラスが、`vector_store.as_retriever()`のように、具体的なベクトルストアライブラリ（ChromaDB）の実装に依存しています。
  - **解決策:** リトリーバーを取得するロジックを`VectorStoreManager`にカプセル化し、戦略クラスをインフラストラクチャ層の詳細から完全に切り離します。

- **方針3: LLMに依存する高度なロジックのテスト**
  - **課題:** `MultiQueryRetriever`のように、LLMが動的に処理内容を決定するコンポーネントは、単純なユニットテストが困難です。
  - **解決策:** LangChainが提供する `FakeListLLM` の活用、生成されるクエリのスナップショットテスト、そしてLangSmithを用いたE2E評価を組み合わせ、信頼性を確保します。
