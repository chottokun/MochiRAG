# MochiRAG プロジェクト テスト実行ガイド

このドキュメントは、MochiRAGプロジェクトに実装されている自動テストを実行し、その結果についてフィードバックをいただくためのガイドです。

## 1. テスト環境のセットアップ

テストを実行する前に、開発環境がセットアップされていることを確認してください。
まだセットアップしていない場合は、`README.md` のインストール手順に従ってください。
特に、テストを実行するには **テスト用の依存関係** がインストールされている必要があります。

### セットアップの要点

1.  **仮想環境の有効化**:
    ```bash
    source venv/bin/activate
    ```

2.  **テスト用依存関係のインストール**:
    *   `setup_dev.sh` スクリプトを使用した場合は、テスト用の依存関係もすでにインストールされています。
    *   手動でセットアップした場合、または確認したい場合は、以下のコマンドでテスト用パッケージをインストールできます。`[test]` を指定するのがポイントです。
      ```bash
      # uv を使う場合 (高速)
      uv pip install ".[test]"
      ```
      ```bash
      # pip を使う場合
      pip install ".[test]"
      ```

## 2. テストの実行

テストは `pytest` フレームワークを使用しています。プロジェクトのルートディレクトリで以下のコマンドを実行してください。

1.  **基本的なテスト実行**:
    *   すべてのテストを実行します。
        ```bash
        pytest
        ```

2.  **詳細な出力でのテスト実行**:
    *   各テストの結果をより詳細に表示します。エラー発生時の原因特定に役立ちます。
        ```bash
        pytest -vv
        ```

3.  **特定のテストファイルの実行**:
    *   特定のテストファイルのみを実行したい場合は、ファイルパスを指定します。
        ```bash
        pytest tests/backend/test_auth.py
        ```

### 2.1 テストを段階的に実施する方法

テストを一度にすべて実行するのではなく、段階的に範囲を広げて実施することで、問題の切り分けやデバッグが容易になります。以下の手順を参考にしてください。

1. **特定のテスト関数のみを実行**  
   まずは1つのテスト関数だけを指定して実行し、最小単位で動作確認します。
   ```bash
   pytest tests/backend/test_auth.py -k test_login_for_access_token
   ```
   `-k` オプションで関数名の一部を指定できます。

2. **特定のテストファイルのみを実行**  
   問題がなければ、次にファイル単位で実行します。
   ```bash
   pytest tests/backend/test_auth.py
   ```

3. **すべてのテストを実行**  
   最後に、全体のテストスイートを実行して、他のテストとの干渉や全体の整合性を確認します。
   ```bash
   pytest
   ```

このように段階的にテストを進めることで、エラー発生時の原因特定が容易になります。

## 3. 期待される結果 (現状)

-   現在実装されているテスト（主に `tests/backend/test_auth.py` 内の認証関連テスト）は、**すべてパスする（成功する）こと**を期待しています。
-   これらのテストは、ユーザーデータベースの代わりに一時的なテスト用データベースを使用し、各テストケースの独立性を保つように設計されています。

## 4. フィードバックのお願い

テスト結果や内容に関して、以下の点についてフィードバックをいただけると大変助かります。

### テストが失敗する場合
-   **失敗したテストケース名**: どのテスト関数（例: `test_login_for_access_token`）が失敗したか。
-   **完全なエラーメッセージとトレースバック**: `pytest` が出力したエラーメッセージ全体と、エラー発生箇所までのスタックトレース。

### テストが成功する場合
-   すべてのテストが問題なくパスした旨のご連絡。

### テスト改善に関するご提案（任意）
-   **不足しているテストケース**: 「〇〇のシナリオについてもテストを追加すべきではないか？」といったご提案。
-   **テストの前提条件やアサーションに関するコメント**: テストコード内の仮定や検証内容についての妥当性など。
-   **テストコードの可読性や効率性に関するフィードバック**: より良いテストコードにするためのアイデア。

### 【任意】Ollama関連のフィードバック（将来のため、Ollama環境をお持ちの場合）
-   この `pytest` スイートには含まれていませんが、もしローカルにOllama (`gemma3:4b-it-qat` モデルを含む) の実行環境をお持ちでしたら、`core/rag_chain.py` の自己実行テストをお試しいただくことも可能です。
    ```bash
    python -m core.rag_chain
    ```
    このスクリプトは、Ollamaとの連携を含むRAGチェーンの動作テストを試みます。その際の出力（特にエラーなく応答が生成されるか、またはOllama接続エラーが適切に表示されるかなど）に関するフィードバックは、RAG機能の今後の開発にとって非常に有益です。
    *   **注意**: 現在の自動テスト環境ではOllamaが実行されていないため、`core.rag_chain` のテストはLLM連携部分で接続エラーとなり、フォールバックメッセージ（「I'm sorry, but I encountered an error...」）が表示されることを想定しています。

ご協力のほど、どうぞよろしくお願いいたします。
